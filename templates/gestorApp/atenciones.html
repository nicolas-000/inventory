{% extends "gestorApp/base.html" %}
{% load static %}

{% block titulo %}Pagina de Inicio{% endblock %}
{% block atenciones %}active{% endblock %}
{% block css %}
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
<link rel="stylesheet" href="{% static 'css/dataTables.bootstrap5.min.css' %}"/>

{% endblock %}

{% block contenido %}
    <div class="container mt-5">
    <div class="row mx-auto">
        <h2 class="mb-4">Registrar Atención</h2>
    </div>
        <form method="post">
            {% csrf_token %}
            <div class="row mx-auto">
                <div class="form-group col-6">
                    <label for="idPropietario">Cliente:</label>
                    {{ form.idPropietario }}
                    {% for error in form.idPropietario.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
                <div class="form-group col-6">
                    <label for="idVehiculo">Vehiculo:</label>
                    {{ form.idVehiculo }}
                    {% for error in form.idVehiculo.errors %}
                        <div class="text-danger">{{ error }}</div>
                    {% endfor %}
                </div>
            </div> 
            <div class="row mx-auto">
                <div class="form-group col-6 mt-2">
                    <label for="fechaInicio">Fecha de inicio:</label>
                    {{ form.fechaInicio }}
                </div>
                <div class="form-group col-6 mt-2">
                    <label for="estado">Estado:</label>
                    {{ form.estado }}
                </div>
            </div>
            <div class="row mx-auto">
                <div class="form-group mt-2">
                    <label for="descripcion">Descripción:</label>
                    {{ form.descripcion }}
                </div>
            </div>
            <div class="row mx-auto">
                <div class="col-3 mt-2">
                    <button type="submit" class="btn btn-primary my-3">Guardar</button>
                </div>
            </div>
        </form>

        <hr>

        <h2>Listado de Atenciones</h2>
        <table class="table table-striped table-hover" id="atencionTable" style="width: 100%">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Cliente</th>
                    <th>Fecha de Inicio</th>
                    <th>Vehículo</th>
                    <th>Descripción</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for atencion in atenciones %}
                <tr>
                    <td data-idPropietario="{{ atencion.idPropietario.id }}">{{ atencion.id }}</td>
                    <td>{{ atencion.idPropietario.nombreCompleto }}</td>
                    <td>{{ atencion.fechaInicio }}</td>
                    <td>{{ atencion.idVehiculo.marca }}</td>
                    <td>{{ atencion.descripcion }}</td>
                    <td>{{ atencion.get_estado_display }}</td>
                    <td class="d-flex justify-content-between">
                        <a href="{% url 'modificarAtencion' atencion.id %}" class="btn btn-warning">Editar</a>
                        {% if atencion.get_estado_display == "Pendiente" %}
                            <a href="{% url 'agregar_repuesto' atencion.id %}" class="btn btn-info">Agregar Repuestos</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <script src="{% static 'js/jquery-3.7.1.min.js' %}"></script>
    <script src="{% static 'js/datatables.min.js' %}"></script>
    <script src="{% static 'js/dataTables.responsive.min.js' %}"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.1.3/dist/lux/bootstrap.min.css">
</body>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const clienteSelect = document.getElementById('idPropietario');
        const vehiculoSelect = document.getElementById('idVehiculo');
    
        clienteSelect.addEventListener('change', function() {
            const clienteId = clienteSelect.value;
            
            fetch(`/get_vehiculos/${clienteId}/`)
                .then(response => response.json())
                .then(data => {
                    vehiculoSelect.innerHTML = '';
                    
                    data.vehiculos.forEach(vehiculo => {
                        const option = document.createElement('option');
                        option.value = vehiculo.id;
                        option.textContent = vehiculo.nombre;
                        vehiculoSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error fetching vehicles:', error));
        });
    });

    $(document).ready(function () {
        $("#atencionTable").DataTable({
            language: {
                url: "{% static 'locale/datatables-plug-ins-2.0.8-i18n-es-CL.json' %}",
            },
            select: {
                style: "single",
                info: false,
            },
        });
    });
</script>

{% endblock %}
  